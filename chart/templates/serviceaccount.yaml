{{- if .Values.serviceAccount.create -}}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "harvester-vm-dhcp-controller.serviceAccountName" . }} # SA per il Controller
  labels:
    {{- include "harvester-vm-dhcp-controller.labels" . | nindent 4 }}
  {{- with .Values.serviceAccount.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
automountServiceAccountToken: {{ .Values.serviceAccount.automount | default true }}
{{- end -}}

{{- /*
  Logica per determinare se creare il SA del Webhook e con quali valori.
*/}}
{{- $createWebhookSA := false -}}
{{- $webhookSAName := printf "%s-webhook" (include "harvester-vm-dhcp-controller.fullname" .) -}}
{{- $webhookSAAnnotations := dict -}}
{{- $webhookSAAutomount := .Values.serviceAccount.automount | default true -}}

{{- if .Values.webhook -}}
  {{- $webhookEnabled := true -}}
  {{- if hasKey .Values.webhook "enabled" -}}
    {{- $webhookEnabled = .Values.webhook.enabled -}}
  {{- end -}}

  {{- if $webhookEnabled -}}
    {{- $webhookSpecificSACreate := true -}}
    {{- if and (hasKey .Values.webhook "serviceAccount") (hasKey .Values.webhook.serviceAccount "create") -}}
      {{- $webhookSpecificSACreate = .Values.webhook.serviceAccount.create -}}
    {{- end -}}

    {{- if and .Values.serviceAccount.create $webhookSpecificSACreate -}}
      {{- $createWebhookSA = true -}}
      {{- if and (hasKey .Values.webhook "serviceAccount") .Values.webhook.serviceAccount -}}
        {{- if .Values.webhook.serviceAccount.name -}}
          {{- $webhookSAName = .Values.webhook.serviceAccount.name -}}
        {{- end -}}
        {{- if .Values.webhook.serviceAccount.annotations -}}
          {{- $webhookSAAnnotations = .Values.webhook.serviceAccount.annotations -}}
        {{- end -}}
        {{- if hasKey .Values.webhook.serviceAccount "automount" -}}
          {{- $webhookSAAutomount = .Values.webhook.serviceAccount.automount -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if $createWebhookSA -}}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $webhookSAName }}
  labels:
    {{- include "harvester-vm-dhcp-webhook.labels" . | nindent 4 }}
  {{- with $webhookSAAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
automountServiceAccountToken: {{ $webhookSAAutomount }}
{{- end -}}
